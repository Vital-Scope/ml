## ML Service — предикт гипоксии (FastAPI + Docker)

Современный сервис на FastAPI, который по данным пациента вычисляет вероятность отклонений (риск гипоксии). Сервис использует обученную модель (`best_model.joblib`) и предоставляет HTTP‑эндпоинт для получения предсказания.

### Основные возможности
- **HTTP API**: GET `'/api/predict/?guid=...'` возвращает вероятность отклонения.
- **Контейнеризация**: полный запуск через Docker.
- **Повторяемость**: модель и пайплайн предобработки сохраняются и используются для инференса.

### Архитектура
- `main.py` — FastAPI приложение и эндпоинт `GET /api/predict/`.
- `run.py` — запуск Uvicorn (0.0.0.0:8082).
- `predict.py` — логика `analyze_folder(folder_path)`: загрузка модели, подготовка признаков и расчёт вероятности.
- `train_model.py` — обучение и сохранение лучшей модели в `best_model.joblib`.
- `create_dataset.py` — функции формирования признаков из сырых CSV.
- `Dockerfile` — образ сервиса.

Эндпоинт ожидает, что в контейнере данные доступны по пути `/proxy/{guid}` — это папка пациента с CSV‑файлами, на основе которых извлекаются признаки и считается вероятность.

---

## Быстрый старт (Docker)

### 1) Сборка образа
```bash
docker build -t ml-service:latest .
```

### 2) Подготовьте данные
Разместите папку пациента с CSV‑файлами у себя локально. Допустим, папка называется `123e4567` и лежит по пути:
- Windows: `C:\data\patients\123e4567`
- Linux/macOS: `/home/user/data/patients/123e4567`

Контейнеру нужно смонтировать родительскую директорию как `/proxy`, чтобы путь `/proxy/123e4567` был доступен внутри контейнера.

### 3) Запуск контейнера
Пробрасываем порт 8082 и монтируем том с данными в `/proxy` (только чтение):

Windows (PowerShell):
```powershell
docker run --rm -p 8082:8082 -v C:\data\patients:/proxy:ro ml-service:latest
```

Linux/macOS:
```bash
docker run --rm -p 8082:8082 -v /home/user/data/patients:/proxy:ro ml-service:latest
```

После запуска сервер будет доступен на `http://localhost:8082`.

### 4) Вызов эндпоинта предсказания
Передайте `guid` — это имя папки пациента внутри `/proxy`.

Пример:
```bash
curl "http://localhost:8082/api/predict/?guid=123e4567"
```

Ответ — строка с числом от 0 до 1 (вероятность отклонения), например:
```text
0.618
```

---

## Локальный запуск без Docker

Требуется Python 3.11+.

1) Установите зависимости:
```bash
pip install -r requirements.txt
```

2) Запустите сервер разработки:
```bash
python run.py
```

Сервер поднимется на `http://0.0.0.0:8082`. Эндпоинт: `GET /api/predict/?guid=...`.

Важно: локально путь до данных должен существовать как `/proxy/{guid}`. Для разработки можно либо создать такую директорию в корне проекта и подставить абсолютный путь в `main.py`, либо смонтировать/ссылаться на неё соответствующим образом.

---

## Подготовка/формат данных

Сервис ожидает структуру данных, совместимую с функциями из `create_dataset.py`. На вход подаётся папка пациента `guid` с одним или несколькими CSV‑файлами (сигналами). Признаки извлекаются автоматически, дальше применяется сохранённый пайплайн препроцессинга и модель.

Если структура данных иная, адаптируйте функции извлечения признаков в `create_dataset.py` и переобучите модель (см. ниже).

---

## Обучение/переобучение модели

1) Подготовьте датасет `medical_dataset.csv` с целевой колонкой `target` и признаками, совместимыми с пайплайном.
2) Запустите обучение:
```bash
python train_model.py
```
3) В результате появится `best_model.joblib` — его использует сервис при инференсе.

При изменении набора признаков не забудьте синхронизировать логику в `predict.py`/`create_dataset.py`.

---

## Технические детали
- Порт сервиса внутри контейнера: `8082` (пробрасывается наружу при запуске `-p 8082:8082`).
- Команда запуска в контейнере: `python run.py` → Uvicorn с `main:app`.
- Основные зависимости: FastAPI, Uvicorn, scikit-learn, XGBoost, NumPy, Pandas.

---

## Частые вопросы (FAQ)

- **Почему эндпоинт требует `guid`?**  Имя папки пациента определяет путь `/proxy/{guid}` внутри контейнера, откуда читаются CSV‑файлы.
- **Как правильно смонтировать том на Windows?**  Используйте абсолютный путь без кавычек, как в примере для PowerShell. Убедитесь, что Docker Desktop имеет доступ к вашему диску (Settings → Resources → File Sharing).
- **Можно ли поменять порт?**  Да, измените проброс порта (например, `-p 9000:8082`) и/или порт в `run.py`/`uvicorn`.

---

## Пример запроса/ответа

Запрос:
```bash
curl "http://localhost:8082/api/predict/?guid=123e4567"
```

Ответ:
```text
0.274
```

Число — вероятность отклонения (чем ближе к 1, тем выше риск).


